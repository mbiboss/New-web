<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>YouTube Audio Player</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #0f0c29;
    --bg-gradient: linear-gradient(to bottom, #24243e, #302b63, #0f0c29);
    --card: rgba(255, 255, 255, 0.05);
    --accent: #6e44ff;
    --accent-hover: #7d55ff;
    --text: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --success: #00c853;
    --error: #ff5252;
    --warning: #ffab00;
    --progress-bg: rgba(255, 255, 255, 0.1);
    --progress-fill: var(--accent);
    --chip-bg: rgba(110, 68, 255, 0.15);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    --transition: all 0.3s ease;
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
    background: var(--bg-gradient);
    color: var(--text);
    overflow-x: hidden;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  .wrap {
    width: 100%;
    max-width: 800px;
    background: var(--card);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: var(--shadow);
    border: 1px solid var(--glass-border);
  }

  .app-header {
    text-align: center;
    margin-bottom: 25px;
  }

  h1 {
    margin: 0 0 10px;
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(to right, #6e44ff, #ff5252);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  p.note {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
  }

  .input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  #urlInput {
    flex: 1;
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text);
    font-size: 16px;
    transition: var(--transition);
  }

  #urlInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(110, 68, 255, 0.3);
  }

  #loadBtn {
    padding: 16px 24px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #loadBtn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
  }

  .section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-secondary);
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 25px;
  }

  .chip {
    background: var(--chip-bg);
    padding: 10px 18px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    border: 1px solid transparent;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chip:hover {
    background: rgba(110, 68, 255, 0.25);
    transform: translateY(-2px);
  }

  .chip i {
    font-size: 12px;
  }

  .player-container {
    margin-top: 30px;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--glass-border);
  }

  .thumbnail-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: var(--transition);
  }

  .thumbnail-container:hover .thumbnail-overlay {
    opacity: 1;
  }

  .play-thumb-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
  }

  .play-thumb-button:hover {
    transform: scale(1.1);
    background: var(--accent-hover);
  }

  .player-controls {
    padding: 20px;
  }

  .song-info {
    margin-bottom: 20px;
  }

  .song-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .song-channel {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0;
  }

  .progress-container {
    margin-bottom: 20px;
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--progress-bg);
    overflow: hidden;
    margin-bottom: 8px;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: var(--progress-fill);
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .control-button {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: none;
    background: var(--glass);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
  }

  .control-button:hover {
    background: var(--accent);
    transform: translateY(-2px);
  }

  .play-button {
    width: 60px;
    height: 60px;
    background: var(--accent);
    font-size: 20px;
  }

  .volume-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
  }

  .volume-icon {
    color: var(--text-secondary);
    font-size: 20px;
  }

  .volume-slider {
    width: 100px;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--progress-bg);
    outline: none;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: var(--transition);
  }

  .volume-slider::-webkit-slider-thumb:hover {
    background: var(--accent-hover);
    transform: scale(1.2);
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 12px 20px;
    border-radius: 12px;
    background: var(--glass);
    font-size: 14px;
  }

  .status {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
  }

  .status-dot.ready {
    background: var(--success);
  }

  .status-dot.playing {
    background: var(--success);
    animation: pulse 1.5s infinite;
  }

  .status-dot.paused {
    background: var(--warning);
  }

  .status-dot.error {
    background: var(--error);
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  @media (max-width: 768px) {
    body {
      padding: 15px;
      align-items: flex-start;
    }
    
    .wrap {
      padding: 20px;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .input-group {
      flex-direction: column;
    }
    
    .thumbnail-container {
      height: 180px;
    }
    
    .controls {
      justify-content: center;
    }
    
    .volume-container {
      display: none;
    }
  }

  /* Loading animation */
  .loader {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="app-header">
      <h1>YouTube Audio Player</h1>
      <p class="note">Convert YouTube videos to audio. Paste a link or choose from suggestions, then press Load and Play.</p>
    </div>

    <div class="input-group">
      <input id="urlInput" type="text" placeholder="Paste YouTube URL or ID here" inputmode="url" />
      <button id="loadBtn">
        <i class="fas fa-play"></i> Load
      </button>
      <button id="downloadBtn" style="padding: 16px 20px; border-radius: 12px; border: none; background: var(--success); color: white; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-download"></i> Download
      </button>
    </div>

    <div class="section-title">
      Popular Songs 
      <button id="refreshSuggestions" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--accent); color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="chips" id="suggestions"></div>

    <div class="player-container">
      <div class="thumbnail-container" id="playerContainer">
        <img class="thumbnail" id="thumbnailImg" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTUyMDMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlhYTRiMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIHNvbmcgbG9hZGVkPC90ZXh0Pjwvc3ZnPg==" alt="No song loaded">
        <div class="thumbnail-overlay">
          <button class="play-thumb-button" id="thumbPlay">
            <i class="fas fa-play"></i>
          </button>
        </div>
      </div>

      <div class="player-controls">
        <div class="song-info">
          <div class="song-title" id="songTitle">No song loaded</div>
          <div class="song-channel" id="songChannel">Select a song to begin</div>
        </div>

        <div class="progress-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="time-display">
            <div id="timeCur">0:00</div>
            <div id="timeDur">0:00</div>
          </div>
        </div>

        <div class="controls">
          <button class="control-button" id="prevBtn">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="control-button play-button" id="playPause">
            <i class="fas fa-play"></i>
          </button>
          <button class="control-button" id="nextBtn">
            <i class="fas fa-step-forward"></i>
          </button>
          
          <div class="volume-container">
            <i class="fas fa-volume-up volume-icon"></i>
            <input id="volume" class="volume-slider" type="range" min="0" max="100" value="80" />
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status">
        <div class="status-dot ready" id="statusDot"></div>
        <div class="status-text" id="status">Ready - paste a link or select a song</div>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  console.log('Fresh YouTube Audio Player Loaded - No Cache Version');

  // Settings & samples
  let SUGGESTIONS = [
    { title: "Arijit Singh - Tum Hi Ho", channel: "Arijit Singh", url: "https://www.youtube.com/watch?v=Umqb9KENgmk", id: "Umqb9KENgmk" },
    { title: "Coldplay - Adventure of a Lifetime", channel: "Coldplay", url: "https://www.youtube.com/watch?v=QtXby3twMmI", id: "QtXby3twMmI" },
    { title: "Ed Sheeran - Shape of You", channel: "Ed Sheeran", url: "https://www.youtube.com/watch?v=JGwWNGJdvx8", id: "JGwWNGJdvx8" },
    { title: "The Weeknd - Blinding Lights", channel: "The Weeknd", url: "https://www.youtube.com/watch?v=4NRXx6U8ABQ", id: "4NRXx6U8ABQ" }
  ];

  // More trending songs to rotate through
  const TRENDING_SUGGESTIONS = [
    { title: "Dua Lipa - Levitating", channel: "Dua Lipa", url: "https://www.youtube.com/watch?v=TUVcZfQe-Kw", id: "TUVcZfQe-Kw" },
    { title: "Harry Styles - As It Was", channel: "Harry Styles", url: "https://www.youtube.com/watch?v=H5v3kku4y6Q", id: "H5v3kku4y6Q" },
    { title: "Billie Eilish - bad guy", channel: "Billie Eilish", url: "https://www.youtube.com/watch?v=DyDfgMOUjCI", id: "DyDfgMOUjCI" },
    { title: "Post Malone - Circles", channel: "Post Malone", url: "https://www.youtube.com/watch?v=wXhTHyIgQ_U", id: "wXhTHyIgQ_U" },
    { title: "Olivia Rodrigo - drivers license", channel: "Olivia Rodrigo", url: "https://www.youtube.com/watch?v=ZmDBbnmKpqQ", id: "ZmDBbnmKpqQ" },
    { title: "Glass Animals - Heat Waves", channel: "Glass Animals", url: "https://www.youtube.com/watch?v=mRD0-GxqHVo", id: "mRD0-GxqHVo" },
    { title: "Lil Nas X - MONTERO", channel: "Lil Nas X", url: "https://www.youtube.com/watch?v=6swmTBVI83c", id: "6swmTBVI83c" },
    { title: "Taylor Swift - Anti-Hero", channel: "Taylor Swift", url: "https://www.youtube.com/watch?v=b1kbLWvqugk", id: "b1kbLWvqugk" }
  ];

  // UI & DOM references
  const suggestionsEl = document.getElementById('suggestions');
  const urlInput = document.getElementById('urlInput');
  const loadBtn = document.getElementById('loadBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const refreshBtn = document.getElementById('refreshSuggestions');
  const playPauseBtn = document.getElementById('playPause');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const volumeEl = document.getElementById('volume');
  const statusEl = document.getElementById('status');
  const statusDot = document.getElementById('statusDot');
  const playerContainer = document.getElementById('playerContainer');
  const thumbnailImg = document.getElementById('thumbnailImg');
  const thumbPlay = document.getElementById('thumbPlay');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const timeCurEl = document.getElementById('timeCur');
  const timeDurEl = document.getElementById('timeDur');
  const songTitleEl = document.getElementById('songTitle');
  const songChannelEl = document.getElementById('songChannel');

  // Player state vars
  let player = null;
  let fallbackIframe = null;
  let ytReady = false;
  let currentVideoId = null;
  let currentVideoTitle = "No song loaded";
  let currentVideoChannel = "Select a song to begin";
  let progressTimer = null;
  let isPlaying = false;
  let currentSuggestionIndex = 0;

  // Helpers
  function extractVideoID(input) {
    if (!input) return null;
    input = input.trim();
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
    
    const patterns = [
      /v=([a-zA-Z0-9_-]{11})/,
      /youtu\.be\/([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
      /\/v\/([a-zA-Z0-9_-]{11})/
    ];
    
    for (const p of patterns) {
      const m = input.match(p);
      if (m && m[1]) return m[1];
    }
    return null;
  }

  function setStatus(text, type = "ready") {
    statusEl.textContent = text;
    statusDot.className = "status-dot " + type;
  }

  function formatTime(sec) {
    sec = Math.max(0, Math.floor(sec || 0));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return m + ":" + (s < 10 ? "0" + s : s);
  }

  function updateThumbnail(videoId) {
    if (videoId) {
      thumbnailImg.src = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
      thumbnailImg.alt = currentVideoTitle;
    } else {
      thumbnailImg.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTUyMDMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlhYTRiMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIHNvbmcgbG9hZGVkPC90ZXh0Pjwvc3ZnPg==";
      thumbnailImg.alt = "No song loaded";
    }
  }

  // Render suggestions
  function renderSuggestions() {
    suggestionsEl.innerHTML = '';
    SUGGESTIONS.forEach((s, index) => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.innerHTML = `<i class="fas fa-music"></i> ${s.title}`;
      btn.onclick = () => {
        urlInput.value = s.url;
        onLoadClicked(true);
        currentSuggestionIndex = index;
      };
      suggestionsEl.appendChild(btn);
    });
  }
  
  // Initial render
  renderSuggestions();

  // YouTube API ready
  function onYouTubeIframeAPIReady() {
    ytReady = true;
    setStatus('YouTube API ready', 'ready');
  }
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

  // Create YT player - FIXED VERSION
  function createYTPlayer(videoId, autoplay = true, startSeconds = 0) {
    console.log('createYTPlayer called with videoId:', videoId);
    
    // Clear any existing content
    if (fallbackIframe) {
      try { fallbackIframe.remove(); } catch(e) {}
      fallbackIframe = null;
    }
    
    // Use the correct container reference
    playerContainer.innerHTML = `
      <img class="thumbnail" id="thumbnailImg" src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" alt="${currentVideoTitle}">
      <div class="thumbnail-overlay">
        <button class="play-thumb-button" id="thumbPlay">
          <i class="fas fa-pause"></i>
        </button>
      </div>
      <div id="ytplayer_inner"></div>
    `;
    
    // Create the YouTube player
    try {
      player = new YT.Player('ytplayer_inner', {
        width: '100%', 
        height: '100%', 
        videoId: videoId,
        playerVars: {
          autoplay: autoplay ? 1 : 0,
          playsinline: 1,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          enablejsapi: 1,
          origin: location.origin || 'null'
        },
        events: {
          onReady: function(e) {
            console.log('YouTube player ready');
            try { 
              player.setVolume(parseInt(volumeEl.value,10)); 
            } catch(e){ console.log('Volume set error:', e); }
            
            if (startSeconds > 0) {
              try { 
                player.seekTo(startSeconds, true); 
              } catch(e){ console.log('Seek error:', e); }
            }
            
            if (autoplay) {
              try { 
                player.playVideo(); 
                isPlaying = true;
                updatePlayButton();
                setStatus('Playing', 'playing');
                startProgress();
              } catch(e){ console.log('Play error:', e); }
            }
          },
          onStateChange: onPlayerStateChange,
          onError: function(e) {
            setStatus('Error playing video', 'error');
            console.error('YouTube player error:', e);
          }
        }
      });
    } catch(e) {
      console.error('Error creating YouTube player:', e);
      createFallbackIframe(videoId);
    }
  }

  function onPlayerStateChange(ev) {
    const s = ev.data;
    if (s === YT.PlayerState.PLAYING) { 
      isPlaying = true;
      updatePlayButton();
      setStatus('Playing', 'playing'); 
      startProgress(); 
    }
    else if (s === YT.PlayerState.PAUSED) { 
      isPlaying = false;
      updatePlayButton();
      setStatus('Paused', 'paused'); 
      stopProgress(); 
    }
    else if (s === YT.PlayerState.ENDED) { 
      isPlaying = false;
      updatePlayButton();
      setStatus('Song ended - playing next...', 'ready'); 
      stopProgress(); 
      progressFill.style.width = '100%';
      // Autoplay next song
      setTimeout(() => {
        playNextSong();
      }, 1000);
    }
    else if (s === YT.PlayerState.BUFFERING) { 
      setStatus('Buffering...', 'paused'); 
    }
    else if (s === YT.PlayerState.CUED) { 
      setStatus('Cued', 'ready'); 
    }
  }

  function updatePlayButton() {
    if (isPlaying) {
      playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      const thumbBtn = document.getElementById('thumbPlay');
      if (thumbBtn) thumbBtn.innerHTML = '<i class="fas fa-pause"></i>';
    } else {
      playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      const thumbBtn = document.getElementById('thumbPlay');
      if (thumbBtn) thumbBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
  }

  // Fallback iframe
  function createFallbackIframe(videoId) {
    console.log('Creating fallback iframe for:', videoId);
    if (fallbackIframe) try { fallbackIframe.remove(); } catch(e){}
    if (player) {
      try { player.destroy(); } catch(e){}
      player = null;
    }
    
    playerContainer.innerHTML = '';
    const ifr = document.createElement('iframe');
    ifr.className = 'yt';
    ifr.style.width = '100%';
    ifr.style.height = '100%';
    ifr.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&playsinline=1&controls=0&rel=0&modestbranding=1&enablejsapi=1';
    ifr.allow = 'autoplay; encrypted-media; fullscreen';
    ifr.setAttribute('frameborder','0');
    playerContainer.appendChild(ifr);
    fallbackIframe = ifr;
    
    isPlaying = true;
    updatePlayButton();
    setStatus('Playing (fallback mode)', 'playing');
    updateThumbnail(videoId);
    
    stopProgress();
    timeCurEl.textContent = '0:00';
    timeDurEl.textContent = 'â€”';
  }

  // UI: Load, Play, Stop
  function onLoadClicked(userGesture = false) {
    const id = extractVideoID(urlInput.value);
    if (!id) { 
      setStatus('Invalid YouTube link or ID', 'error'); 
      return; 
    }
    
    currentVideoId = id;
    
    // Try to get video title from suggestions
    const suggestion = SUGGESTIONS.find(s => s.id === id);
    if (suggestion) {
      currentVideoTitle = suggestion.title;
      currentVideoChannel = suggestion.channel;
    } else {
      currentVideoTitle = "Loaded Video";
      currentVideoChannel = "YouTube";
    }
    
    songTitleEl.textContent = currentVideoTitle;
    songChannelEl.textContent = currentVideoChannel;
    updateThumbnail(id);
    
    loadBtn.innerHTML = '<div class="loader"></div> Loading';
    loadBtn.disabled = true;
    
    setTimeout(() => {
      if (ytReady) {
        createYTPlayer(id, true, 0);
      } else {
        createFallbackIframe(id);
      }
      loadBtn.innerHTML = '<i class="fas fa-download"></i> Load';
      loadBtn.disabled = false;
    }, 500);
  }

  // Progress tracking functions
  function startProgress() {
    stopProgress();
    progressTimer = setInterval(updateProgress, 1000);
  }

  function stopProgress() {
    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
  }

  function updateProgress() {
    if (!player || !player.getCurrentTime) return;
    
    try {
      const current = player.getCurrentTime();
      const duration = player.getDuration();
      
      if (current && duration) {
        const percent = (current / duration) * 100;
        progressFill.style.width = percent + '%';
        timeCurEl.textContent = formatTime(current);
        timeDurEl.textContent = formatTime(duration);
      }
    } catch(e) {
      console.log('Progress update error:', e);
    }
  }

  // Event listeners
  loadBtn.onclick = () => onLoadClicked(true);

  playPauseBtn.onclick = () => {
    if (!player && !fallbackIframe) {
      if (currentVideoId) {
        if (ytReady) {
          createYTPlayer(currentVideoId, true);
        } else {
          createFallbackIframe(currentVideoId);
        }
      }
      return;
    }

    if (player && player.getPlayerState) {
      try {
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      } catch(e) {
        console.log('Play/pause error:', e);
      }
    }
  };

  // Thumbnail play button
  document.addEventListener('click', (e) => {
    if (e.target.id === 'thumbPlay' || e.target.parentElement?.id === 'thumbPlay') {
      playPauseBtn.click();
    }
  });

  volumeEl.oninput = () => {
    if (player && player.setVolume) {
      try {
        player.setVolume(parseInt(volumeEl.value, 10));
      } catch(e) {
        console.log('Volume change error:', e);
      }
    }
  };

  // Navigation and autoplay functions
  function playNextSong() {
    if (currentSuggestionIndex < SUGGESTIONS.length - 1) {
      currentSuggestionIndex++;
    } else {
      // Loop back to first song
      currentSuggestionIndex = 0;
    }
    const next = SUGGESTIONS[currentSuggestionIndex];
    urlInput.value = next.url;
    onLoadClicked(true);
  }

  function playPrevSong() {
    if (currentSuggestionIndex > 0) {
      currentSuggestionIndex--;
    } else {
      // Loop to last song
      currentSuggestionIndex = SUGGESTIONS.length - 1;
    }
    const prev = SUGGESTIONS[currentSuggestionIndex];
    urlInput.value = prev.url;
    onLoadClicked(true);
  }

  // Navigation buttons
  prevBtn.onclick = () => {
    playPrevSong();
  };

  nextBtn.onclick = () => {
    playNextSong();
  };

  progressBar.onclick = (e) => {
    if (!player || !player.getDuration) return;
    
    try {
      const duration = player.getDuration();
      const rect = progressBar.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const seekTo = duration * percent;
      player.seekTo(seekTo, true);
    } catch(e) {
      console.log('Seek error:', e);
    }
  };

  // Refresh suggestions functionality
  function refreshSuggestions() {
    // Randomly select 4 songs from trending suggestions
    const shuffled = [...TRENDING_SUGGESTIONS].sort(() => 0.5 - Math.random());
    SUGGESTIONS = shuffled.slice(0, 4);
    renderSuggestions();
    setStatus('Suggestions refreshed!', 'ready');
  }

  // Download functionality
  function downloadAudio() {
    const id = extractVideoID(urlInput.value);
    if (!id) {
      setStatus('Please enter a valid YouTube URL first', 'error');
      return;
    }
    
    // Create download link using yt-dlp compatible service
    const downloadUrl = `https://loader.to/api/button/?f=mp3&color=ff0000&url=https://www.youtube.com/watch?v=${id}`;
    
    // Open download page in new tab
    const downloadWindow = window.open(downloadUrl, '_blank');
    if (downloadWindow) {
      setStatus('Opening download page...', 'ready');
    } else {
      // Fallback - create a temporary link
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.target = '_blank';
      link.click();
      setStatus('Download initiated', 'ready');
    }
  }

  // Event listeners for new buttons
  refreshBtn.onclick = refreshSuggestions;
  downloadBtn.onclick = downloadAudio;

  console.log('YouTube Audio Player fully initialized with autoplay, dynamic suggestions, and download support');
  </script>
</body>
</html>