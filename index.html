<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>YouTube Audio Player</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --bg: #0f0c29;
    --bg-gradient: linear-gradient(to bottom, #24243e, #302b63, #0f0c29);
    --card: rgba(255, 255, 255, 0.05);
    --accent: #6e44ff;
    --accent-hover: #7d55ff;
    --text: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.7);
    --success: #00c853;
    --error: #ff5252;
    --warning: #ffab00;
    --progress-bg: rgba(255, 255, 255, 0.1);
    --progress-fill: var(--accent);
    --chip-bg: rgba(110, 68, 255, 0.15);
    --glass: rgba(255, 255, 255, 0.05);
    --glass-border: rgba(255, 255, 255, 0.1);
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    --transition: all 0.3s ease;
  }

  /* Theme Definitions */
  .theme-light {
    --bg: #f8f9fa;
    --bg-gradient: linear-gradient(to bottom, #e3f2fd, #bbdefb, #90caf9);
    --card: rgba(0, 0, 0, 0.05);
    --accent: #1976d2;
    --accent-hover: #1565c0;
    --text: #212121;
    --text-secondary: rgba(0, 0, 0, 0.6);
    --glass: rgba(0, 0, 0, 0.03);
    --glass-border: rgba(0, 0, 0, 0.1);
    --progress-bg: rgba(0, 0, 0, 0.1);
    --chip-bg: rgba(25, 118, 210, 0.15);
    --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .theme-ocean {
    --bg: #0a1929;
    --bg-gradient: linear-gradient(to bottom, #1e3a8a, #1e40af, #0a1929);
    --card: rgba(59, 130, 246, 0.05);
    --accent: #3b82f6;
    --accent-hover: #2563eb;
    --text: #e0f2fe;
    --text-secondary: rgba(224, 242, 254, 0.7);
    --glass: rgba(59, 130, 246, 0.05);
    --glass-border: rgba(59, 130, 246, 0.1);
    --progress-bg: rgba(59, 130, 246, 0.1);
    --chip-bg: rgba(59, 130, 246, 0.15);
  }

  .theme-forest {
    --bg: #1a2e05;
    --bg-gradient: linear-gradient(to bottom, #2e7d32, #388e3c, #1a2e05);
    --card: rgba(76, 175, 80, 0.05);
    --accent: #4caf50;
    --accent-hover: #43a047;
    --text: #e8f5e8;
    --text-secondary: rgba(232, 245, 232, 0.7);
    --glass: rgba(76, 175, 80, 0.05);
    --glass-border: rgba(76, 175, 80, 0.1);
    --progress-bg: rgba(76, 175, 80, 0.1);
    --chip-bg: rgba(76, 175, 80, 0.15);
  }

  .theme-sunset {
    --bg: #3e2723;
    --bg-gradient: linear-gradient(to bottom, #ff5722, #ff7043, #3e2723);
    --card: rgba(255, 87, 34, 0.05);
    --accent: #ff5722;
    --accent-hover: #f4511e;
    --text: #fff3e0;
    --text-secondary: rgba(255, 243, 224, 0.7);
    --glass: rgba(255, 87, 34, 0.05);
    --glass-border: rgba(255, 87, 34, 0.1);
    --progress-bg: rgba(255, 87, 34, 0.1);
    --chip-bg: rgba(255, 87, 34, 0.15);
  }

  .theme-neon {
    --bg: #000000;
    --bg-gradient: linear-gradient(to bottom, #1a1a2e, #16213e, #000000);
    --card: rgba(0, 255, 255, 0.05);
    --accent: #00ffff;
    --accent-hover: #00e6e6;
    --text: #ffffff;
    --text-secondary: rgba(255, 255, 255, 0.8);
    --glass: rgba(0, 255, 255, 0.05);
    --glass-border: rgba(0, 255, 255, 0.2);
    --progress-bg: rgba(0, 255, 255, 0.1);
    --chip-bg: rgba(0, 255, 255, 0.15);
    --shadow: 0 10px 30px rgba(0, 255, 255, 0.3);
  }

  .theme-rose {
    --bg: #1a0e1a;
    --bg-gradient: linear-gradient(to bottom, #ad1457, #c2185b, #1a0e1a);
    --card: rgba(233, 30, 99, 0.05);
    --accent: #e91e63;
    --accent-hover: #d81b60;
    --text: #fce4ec;
    --text-secondary: rgba(252, 228, 236, 0.7);
    --glass: rgba(233, 30, 99, 0.05);
    --glass-border: rgba(233, 30, 99, 0.1);
    --progress-bg: rgba(233, 30, 99, 0.1);
    --chip-bg: rgba(233, 30, 99, 0.15);
  }

  * {
    box-sizing: border-box;
  }

  html, body {
    height: 100%;
    margin: 0;
    font-family: 'Poppins', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
    background: var(--bg-gradient);
    color: var(--text);
    overflow-x: hidden;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
    min-height: 100vh;
  }

  .wrap {
    width: 100%;
    max-width: 1200px;
    background: var(--card);
    backdrop-filter: blur(10px);
    border-radius: 20px;
    padding: 30px;
    box-shadow: var(--shadow);
    border: 1px solid var(--glass-border);
  }

  .app-header {
    text-align: center;
    margin-bottom: 25px;
  }

  h1 {
    margin: 0 0 10px;
    font-size: 28px;
    font-weight: 700;
    background: linear-gradient(to right, #6e44ff, #ff5252);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  p.note {
    margin: 0;
    color: var(--text-secondary);
    font-size: 14px;
    line-height: 1.5;
  }

  .input-group {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  #urlInput {
    flex: 1;
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text);
    font-size: 16px;
    transition: var(--transition);
  }

  #urlInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(110, 68, 255, 0.3);
  }

  #loadBtn {
    padding: 16px 24px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #loadBtn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
  }

  .section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-secondary);
  }

  .chips {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 25px;
  }

  .chip {
    background: var(--chip-bg);
    padding: 10px 18px;
    border-radius: 50px;
    cursor: pointer;
    font-size: 14px;
    border: 1px solid transparent;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .chip:hover {
    background: rgba(110, 68, 255, 0.25);
    transform: translateY(-2px);
  }

  .chip i {
    font-size: 12px;
  }

  .player-container {
    margin-top: 30px;
    border-radius: 16px;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--glass-border);
  }

  .thumbnail-container {
    position: relative;
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: var(--transition);
  }

  .thumbnail-container:hover .thumbnail-overlay {
    opacity: 1;
  }

  .play-thumb-button {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--accent);
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
  }

  .play-thumb-button:hover {
    transform: scale(1.1);
    background: var(--accent-hover);
  }

  .player-controls {
    padding: 20px;
  }

  .song-info {
    margin-bottom: 20px;
  }

  .song-title {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .song-channel {
    font-size: 14px;
    color: var(--text-secondary);
    margin: 0;
  }

  .progress-container {
    margin-bottom: 20px;
  }

  .progress-bar {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: var(--progress-bg);
    overflow: hidden;
    margin-bottom: 8px;
    cursor: pointer;
  }

  .progress-fill {
    height: 100%;
    width: 0%;
    background: var(--progress-fill);
    border-radius: 3px;
    transition: width 0.3s ease;
  }

  .time-display {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-secondary);
  }

  .controls {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .control-button {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    border: none;
    background: var(--glass);
    color: var(--text);
    font-size: 16px;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
  }

  .control-button:hover {
    background: var(--accent);
    transform: translateY(-2px);
  }

  .play-button {
    width: 60px;
    height: 60px;
    background: var(--accent);
    font-size: 20px;
  }

  .volume-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-left: auto;
  }

  .volume-icon {
    color: var(--text-secondary);
    font-size: 20px;
  }

  .volume-slider {
    width: 100px;
    -webkit-appearance: none;
    height: 4px;
    border-radius: 2px;
    background: var(--progress-bg);
    outline: none;
  }

  .volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    transition: var(--transition);
  }

  .volume-slider::-webkit-slider-thumb:hover {
    background: var(--accent-hover);
    transform: scale(1.2);
  }

  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 12px 20px;
    border-radius: 12px;
    background: var(--glass);
    font-size: 14px;
  }

  .status {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--text-secondary);
  }

  .status-dot.ready {
    background: var(--success);
  }

  .status-dot.playing {
    background: var(--success);
    animation: pulse 1.5s infinite;
  }

  .status-dot.paused {
    background: var(--warning);
  }

  .status-dot.error {
    background: var(--error);
  }

  @keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
  }

  /* Desktop and Ultra-wide Screens */
  @media (min-width: 1440px) {
    .wrap {
      max-width: 1400px;
      padding: 40px;
    }
    
    .player-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      align-items: start;
    }
    
    .thumbnail-container {
      height: 300px;
    }
    
    .search-results {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      max-height: 500px;
    }
    
    .chips {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .queue-container {
      max-height: 300px;
      overflow-y: auto;
    }
  }

  /* Large Desktop Screens */
  @media (min-width: 1024px) and (max-width: 1439px) {
    .wrap {
      max-width: 1200px;
      padding: 35px;
    }
    
    .search-results {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      max-height: 450px;
    }
    
    .thumbnail-container {
      height: 250px;
    }
    
    .controls {
      gap: 20px;
    }
    
    .chips {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }
  }

  /* Standard Desktop/Laptop Screens */
  @media (min-width: 769px) and (max-width: 1023px) {
    .wrap {
      max-width: 900px;
      padding: 30px;
    }
    
    .thumbnail-container {
      height: 220px;
    }
    
    .search-results {
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      max-height: 400px;
    }
  }

  /* Tablet Screens */
  @media (min-width: 481px) and (max-width: 768px) {
    body {
      padding: 15px;
    }
    
    .wrap {
      max-width: 100%;
      padding: 25px;
    }
    
    .thumbnail-container {
      height: 200px;
    }
    
    .search-results {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      max-height: 350px;
    }
    
    .controls {
      justify-content: center;
      gap: 15px;
    }
    
    .volume-container {
      margin-left: 0;
    }
    
    .input-group, .search-group {
      flex-direction: column;
    }
  }

  /* Mobile Screens */
  @media (max-width: 480px) {
    body {
      padding: 10px;
      align-items: flex-start;
    }
    
    .wrap {
      padding: 20px;
      border-radius: 15px;
    }
    
    h1 {
      font-size: 24px;
    }
    
    .input-group, .search-group {
      flex-direction: column;
    }
    
    .thumbnail-container {
      height: 180px;
    }
    
    .controls {
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    
    .volume-container {
      order: 1;
      margin-left: 0;
      width: 100%;
      justify-content: center;
      margin-top: 10px;
    }
    
    .control-button {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .play-button {
      width: 55px;
      height: 55px;
      font-size: 18px;
    }
    
    .search-results {
      grid-template-columns: 1fr;
      max-height: 300px;
    }
    
    .chips {
      gap: 8px;
    }
    
    .chip {
      font-size: 13px;
      padding: 8px 14px;
    }
  }

  /* Landscape Mobile Optimization */
  @media (max-height: 500px) and (orientation: landscape) {
    body {
      padding: 10px;
    }
    
    .wrap {
      padding: 15px;
    }
    
    .app-header {
      margin-bottom: 15px;
    }
    
    h1 {
      font-size: 20px;
      margin-bottom: 5px;
    }
    
    .thumbnail-container {
      height: 120px;
    }
    
    .search-results {
      max-height: 200px;
    }
    
    .chips {
      margin-bottom: 15px;
    }
    
    .queue-container, #favorites, #recentlyPlayed {
      max-height: 150px;
      overflow-y: auto;
    }
  }

  /* Loading animation */
  .loader {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: white;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Search Section Styles */
  .search-section {
    margin-bottom: 25px;
  }

  .search-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
  }

  .search-tab {
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    background: var(--glass);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
    border: 1px solid var(--glass-border);
  }

  .search-tab.active {
    background: var(--accent);
    color: white;
    transform: translateY(-2px);
  }

  .search-tab:hover:not(.active) {
    background: rgba(110, 68, 255, 0.15);
    color: var(--text);
  }

  .search-group {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
  }

  #searchInput {
    flex: 1;
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    background: var(--glass);
    color: var(--text);
    font-size: 16px;
    transition: var(--transition);
  }

  #searchInput:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(110, 68, 255, 0.3);
  }

  #searchBtn {
    padding: 16px 24px;
    border-radius: 12px;
    border: none;
    background: var(--accent);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  #searchBtn:hover {
    background: var(--accent-hover);
    transform: translateY(-2px);
  }

  .search-results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
  }

  .search-result {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 15px;
    cursor: pointer;
    transition: var(--transition);
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .search-result:hover {
    background: rgba(110, 68, 255, 0.15);
    transform: translateY(-2px);
    border-color: var(--accent);
  }

  .search-result-thumb {
    width: 60px;
    height: 45px;
    border-radius: 8px;
    object-fit: cover;
    flex-shrink: 0;
  }

  .search-result-info {
    flex: 1;
    min-width: 0;
  }

  .search-result-title {
    font-weight: 600;
    font-size: 14px;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-result-channel {
    font-size: 12px;
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .search-result-duration {
    font-size: 11px;
    color: var(--text-secondary);
    background: rgba(0, 0, 0, 0.3);
    padding: 2px 6px;
    border-radius: 4px;
    flex-shrink: 0;
  }

  .search-loading {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  .search-empty {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
  }

  @media (max-width: 768px) {
    .search-tabs {
      flex-direction: column;
    }
    
    .search-group {
      flex-direction: column;
    }
    
    .search-results {
      grid-template-columns: 1fr;
    }
    
    .search-result {
      flex-direction: column;
      text-align: center;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <div class="app-header">
      <h1>YouTube Audio Player</h1>
      <p class="note">Convert YouTube videos to audio. Paste a link or choose from suggestions, then press Load and Play.</p>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <div class="search-tabs">
        <button class="search-tab active" id="searchTab">🔍 Search Songs</button>
        <button class="search-tab" id="urlTab">🔗 YouTube URL</button>
      </div>
      
      <div class="search-content" id="searchContent">
        <div class="search-group">
          <input id="searchInput" type="text" placeholder="Search for songs, artists, or albums..." />
          <button id="searchBtn">
            <i class="fas fa-search"></i> Search
          </button>
        </div>
        <div class="search-results" id="searchResults"></div>
      </div>
      
      <div class="url-content" id="urlContent" style="display: none;">
        <div class="input-group">
          <input id="urlInput" type="text" placeholder="Paste YouTube URL or ID here" inputmode="url" />
          <button id="loadBtn">
            <i class="fas fa-play"></i> Load
          </button>
          <button id="downloadBtn" style="padding: 16px 20px; border-radius: 12px; border: none; background: var(--success); color: white; font-weight: 600; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-download"></i> Download
          </button>
        </div>
      </div>
    </div>

    <!-- Song Queue Section -->
    <div class="section-title" id="queueTitle" style="display: none;">
      🎵 Queue
      <button id="clearQueue" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--error); color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
        <i class="fas fa-trash"></i> Clear
      </button>
    </div>
    <div class="queue-container" id="queue" style="margin-bottom: 20px;"></div>
    
    <!-- Favorites Section -->
    <div class="section-title" id="favoritesTitle" style="display: none;">
      ❤️ My Favorites
      <button id="clearFavorites" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--error); color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
        <i class="fas fa-heart-broken"></i> Clear
      </button>
    </div>
    <div class="chips" id="favorites" style="margin-bottom: 20px;"></div>
    
    <!-- Recently Played Section -->
    <div class="section-title" id="recentlyPlayedTitle" style="display: none;">
      🕒 Recently Played
      <button id="clearHistory" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--error); color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
        <i class="fas fa-trash"></i> Clear
      </button>
    </div>
    <div class="chips" id="recentlyPlayed" style="margin-bottom: 20px;"></div>
    
    <div class="section-title">
      Popular Songs 
      <button id="refreshSuggestions" style="margin-left: 10px; padding: 5px 10px; border: none; background: var(--accent); color: white; border-radius: 5px; cursor: pointer; font-size: 12px;">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="chips" id="suggestions"></div>

    <div class="player-container">
      <div class="thumbnail-container" id="playerContainer">
        <img class="thumbnail" id="thumbnailImg" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTUyMDMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlhYTRiMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIHNvbmcgbG9hZGVkPC90ZXh0Pjwvc3ZnPg==" alt="No song loaded">
        <div class="thumbnail-overlay">
          <button class="play-thumb-button" id="thumbPlay">
            <i class="fas fa-play"></i>
          </button>
        </div>
      </div>

      <div class="player-controls">
        <div class="song-info">
          <div class="song-title" id="songTitle">No song loaded</div>
          <div class="song-channel" id="songChannel">Select a song to begin</div>
        </div>

        <div class="progress-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="time-display">
            <div id="timeCur">0:00</div>
            <div id="timeDur">0:00</div>
          </div>
        </div>

        <div class="controls">
          <button class="control-button" id="shuffleBtn" title="Shuffle">
            <i class="fas fa-random"></i>
          </button>
          <button class="control-button" id="favoriteBtn" title="Add to Favorites">
            <i class="far fa-heart"></i>
          </button>
          <button class="control-button" id="prevBtn">
            <i class="fas fa-step-backward"></i>
          </button>
          <button class="control-button play-button" id="playPause">
            <i class="fas fa-play"></i>
          </button>
          <button class="control-button" id="nextBtn">
            <i class="fas fa-step-forward"></i>
          </button>
          <button class="control-button" id="repeatBtn" title="Repeat: Off">
            <i class="fas fa-redo"></i>
          </button>
          
          <button class="control-button" id="speedBtn" title="Playback Speed: 1x">
            <span class="speed-text">1x</span>
          </button>
          
          <div class="volume-container">
            <i class="fas fa-volume-up volume-icon"></i>
            <input id="volume" class="volume-slider" type="range" min="0" max="100" value="80" />
          </div>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status">
        <div class="status-dot ready" id="statusDot"></div>
        <div class="status-text" id="status">Ready - paste a link or select a song</div>
      </div>
      <div class="theme-controls">
        <button class="theme-btn" onclick="showThemeSelector()" title="Change Theme">
          <i class="fas fa-palette"></i>
        </button>
        <button class="keyboard-help-btn" onclick="showKeyboardHelp()" title="Keyboard Shortcuts">
          <i class="fas fa-keyboard"></i>
        </button>
      </div>
    </div>
  </div>

  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
  console.log('Fresh YouTube Audio Player Loaded - No Cache Version');

  // Settings & samples
  let SUGGESTIONS = [
    { title: "Arijit Singh - Tum Hi Ho", channel: "Arijit Singh", url: "https://www.youtube.com/watch?v=Umqb9KENgmk", id: "Umqb9KENgmk" },
    { title: "Coldplay - Adventure of a Lifetime", channel: "Coldplay", url: "https://www.youtube.com/watch?v=QtXby3twMmI", id: "QtXby3twMmI" },
    { title: "Ed Sheeran - Shape of You", channel: "Ed Sheeran", url: "https://www.youtube.com/watch?v=JGwWNGJdvx8", id: "JGwWNGJdvx8" },
    { title: "The Weeknd - Blinding Lights", channel: "The Weeknd", url: "https://www.youtube.com/watch?v=4NRXx6U8ABQ", id: "4NRXx6U8ABQ" }
  ];

  // More trending songs to rotate through
  const TRENDING_SUGGESTIONS = [
    { title: "Dua Lipa - Levitating", channel: "Dua Lipa", url: "https://www.youtube.com/watch?v=TUVcZfQe-Kw", id: "TUVcZfQe-Kw" },
    { title: "Harry Styles - As It Was", channel: "Harry Styles", url: "https://www.youtube.com/watch?v=H5v3kku4y6Q", id: "H5v3kku4y6Q" },
    { title: "Billie Eilish - bad guy", channel: "Billie Eilish", url: "https://www.youtube.com/watch?v=DyDfgMOUjCI", id: "DyDfgMOUjCI" },
    { title: "Post Malone - Circles", channel: "Post Malone", url: "https://www.youtube.com/watch?v=wXhTHyIgQ_U", id: "wXhTHyIgQ_U" },
    { title: "Olivia Rodrigo - drivers license", channel: "Olivia Rodrigo", url: "https://www.youtube.com/watch?v=ZmDBbnmKpqQ", id: "ZmDBbnmKpqQ" },
    { title: "Glass Animals - Heat Waves", channel: "Glass Animals", url: "https://www.youtube.com/watch?v=mRD0-GxqHVo", id: "mRD0-GxqHVo" },
    { title: "Lil Nas X - MONTERO", channel: "Lil Nas X", url: "https://www.youtube.com/watch?v=6swmTBVI83c", id: "6swmTBVI83c" },
    { title: "Taylor Swift - Anti-Hero", channel: "Taylor Swift", url: "https://www.youtube.com/watch?v=b1kbLWvqugk", id: "b1kbLWvqugk" }
  ];

  // UI & DOM references
  const suggestionsEl = document.getElementById('suggestions');
  const urlInput = document.getElementById('urlInput');
  const loadBtn = document.getElementById('loadBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const refreshBtn = document.getElementById('refreshSuggestions');
  const playPauseBtn = document.getElementById('playPause');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const volumeEl = document.getElementById('volume');
  const statusEl = document.getElementById('status');
  const statusDot = document.getElementById('statusDot');
  const playerContainer = document.getElementById('playerContainer');
  const thumbnailImg = document.getElementById('thumbnailImg');
  const thumbPlay = document.getElementById('thumbPlay');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const timeCurEl = document.getElementById('timeCur');
  const timeDurEl = document.getElementById('timeDur');
  const songTitleEl = document.getElementById('songTitle');
  const songChannelEl = document.getElementById('songChannel');
  
  // Search elements
  const searchTab = document.getElementById('searchTab');
  const urlTab = document.getElementById('urlTab');
  const searchContent = document.getElementById('searchContent');
  const urlContent = document.getElementById('urlContent');
  const searchInput = document.getElementById('searchInput');
  const searchBtn = document.getElementById('searchBtn');
  const searchResults = document.getElementById('searchResults');
  const recentlyPlayedEl = document.getElementById('recentlyPlayed');
  const recentlyPlayedTitle = document.getElementById('recentlyPlayedTitle');
  const clearHistoryBtn = document.getElementById('clearHistory');
  const favoritesEl = document.getElementById('favorites');
  const favoritesTitle = document.getElementById('favoritesTitle');
  const clearFavoritesBtn = document.getElementById('clearFavorites');
  const favoriteBtn = document.getElementById('favoriteBtn');
  const shuffleBtn = document.getElementById('shuffleBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const speedBtn = document.getElementById('speedBtn');
  const queueEl = document.getElementById('queue');
  const queueTitle = document.getElementById('queueTitle');
  const clearQueueBtn = document.getElementById('clearQueue');

  // Player state vars
  let player = null;
  let fallbackIframe = null;
  let ytReady = false;
  let currentVideoId = null;
  let currentVideoTitle = "No song loaded";
  let currentVideoChannel = "Select a song to begin";
  let progressTimer = null;
  let isPlaying = false;
  let currentSuggestionIndex = 0;
  let searchCache = new Map();
  let searchTimeout = null;
  let recentlyPlayedSongs = [];
  const MAX_RECENT_SONGS = 10;
  let keyboardShortcutsEnabled = true;
  let currentTheme = 'default';
  let favoriteSongs = [];
  const MAX_FAVORITES = 20;
  let repeatMode = 'none'; // 'none', 'one', 'all'
  let shuffleMode = false;
  let currentPlaylist = [];
  let currentPlaylistIndex = 0;
  let playbackSpeed = 1;
  const availableSpeeds = [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2];
  let songQueue = [];
  const MAX_QUEUE_SIZE = 50;
  
  const themes = {
    default: { name: '🌆 Purple Galaxy', class: '' },
    light: { name: '☁️ Light Sky', class: 'theme-light' },
    ocean: { name: '🌊 Ocean Blue', class: 'theme-ocean' },
    forest: { name: '🌲 Forest Green', class: 'theme-forest' },
    sunset: { name: '🌅 Sunset Orange', class: 'theme-sunset' },
    neon: { name: '🔆 Neon Cyber', class: 'theme-neon' },
    rose: { name: '🌹 Rose Pink', class: 'theme-rose' }
  };

  // Helpers
  function extractVideoID(input) {
    if (!input) return null;
    input = input.trim();
    if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
    
    const patterns = [
      /v=([a-zA-Z0-9_-]{11})/,
      /youtu\.be\/([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
      /\/v\/([a-zA-Z0-9_-]{11})/
    ];
    
    for (const p of patterns) {
      const m = input.match(p);
      if (m && m[1]) return m[1];
    }
    return null;
  }

  function setStatus(text, type = "ready") {
    statusEl.textContent = text;
    statusDot.className = "status-dot " + type;
  }

  function formatTime(sec) {
    sec = Math.max(0, Math.floor(sec || 0));
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    return m + ":" + (s < 10 ? "0" + s : s);
  }

  function updateThumbnail(videoId) {
    if (videoId) {
      thumbnailImg.src = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`;
      thumbnailImg.alt = currentVideoTitle;
    } else {
      thumbnailImg.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTUyMDMzIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzlhYTRiMiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIHNvbmcgbG9hZGVkPC90ZXh0Pjwvc3ZnPg==";
      thumbnailImg.alt = "No song loaded";
    }
  }

  // Search functionality
  function performSearch(query) {
    if (!query.trim()) {
      searchResults.innerHTML = '<div class="search-empty">Enter a search term to find songs</div>';
      return;
    }
    
    // Check cache first
    if (searchCache.has(query)) {
      displaySearchResults(searchCache.get(query));
      return;
    }
    
    searchResults.innerHTML = '<div class="search-loading"><div class="loader"></div> Searching for songs...</div>';
    
    // Simulated search results (in a real app, you'd call YouTube API)
    const mockResults = [
      {
        id: "dQw4w9WgXcQ",
        title: "Rick Astley - Never Gonna Give You Up",
        channel: "Rick Astley",
        thumbnail: `https://i.ytimg.com/vi/dQw4w9WgXcQ/hqdefault.jpg`,
        duration: "3:33"
      },
      {
        id: "9bZkp7q19f0",
        title: "PSY - GANGNAM STYLE",
        channel: "officialpsy",
        thumbnail: `https://i.ytimg.com/vi/9bZkp7q19f0/hqdefault.jpg`,
        duration: "4:12"
      },
      {
        id: "kJQP7kiw5Fk",
        title: "Luis Fonsi - Despacito ft. Daddy Yankee",
        channel: "Luis Fonsi",
        thumbnail: `https://i.ytimg.com/vi/kJQP7kiw5Fk/hqdefault.jpg`,
        duration: "4:42"
      },
      {
        id: "RgKAFK5djSk",
        title: "Wiz Khalifa - See You Again ft. Charlie Puth",
        channel: "Wiz Khalifa",
        thumbnail: `https://i.ytimg.com/vi/RgKAFK5djSk/hqdefault.jpg`,
        duration: "3:57"
      },
      {
        id: "CevxZvSJLk8",
        title: "Katy Perry - Roar",
        channel: "Katy Perry",
        thumbnail: `https://i.ytimg.com/vi/CevxZvSJLk8/hqdefault.jpg`,
        duration: "3:43"
      }
    ];
    
    // Filter results based on query
    const filteredResults = mockResults.filter(result => 
      result.title.toLowerCase().includes(query.toLowerCase()) ||
      result.channel.toLowerCase().includes(query.toLowerCase())
    );
    
    // Cache results
    searchCache.set(query, filteredResults);
    
    // Simulate API delay
    setTimeout(() => {
      displaySearchResults(filteredResults);
    }, 800);
  }
  
  function displaySearchResults(results) {
    if (results.length === 0) {
      searchResults.innerHTML = '<div class="search-empty">No songs found. Try a different search term.</div>';
      return;
    }
    
    const resultsHTML = results.map(result => `
      <div class="search-result" onclick="loadSong('${result.id}', '${result.title.replace(/'/g, "\\'")  }', '${result.channel.replace(/'/g, "\\'")  }', true)">
        <img class="search-result-thumb" src="${result.thumbnail}" alt="${result.title}" loading="lazy">
        <div class="search-result-info">
          <div class="search-result-title">${result.title}</div>
          <div class="search-result-channel">${result.channel}</div>
        </div>
        <div class="search-result-duration">${result.duration}</div>
      </div>
    `).join('');
    
    searchResults.innerHTML = resultsHTML;
  }
  
  function loadSong(videoId, title, channel, autoplay = false) {
    currentVideoId = videoId;
    currentVideoTitle = title;
    currentVideoChannel = channel;
    
    songTitleEl.textContent = title;
    songChannelEl.textContent = channel;
    updateThumbnail(videoId);
    
    // Add to recently played (only when actually playing, not just loading)
    if (autoplay) {
      addToRecentlyPlayed(videoId, title, channel);
    }
    
    // Update favorite button
    updateFavoriteButton();
    
    // Update playlist
    if (autoplay) {
      createPlaylist();
    }
    
    if (ytReady) {
      createYTPlayer(videoId, autoplay);
    } else {
      createFallbackIframe(videoId);
    }
    
    setStatus('Loading song...', 'ready');
  }
  
  // Tab switching
  function switchToSearchTab() {
    searchTab.classList.add('active');
    urlTab.classList.remove('active');
    searchContent.style.display = 'block';
    urlContent.style.display = 'none';
  }
  
  function switchToUrlTab() {
    urlTab.classList.add('active');
    searchTab.classList.remove('active');
    urlContent.style.display = 'block';
    searchContent.style.display = 'none';
  }
  
  // Render suggestions
  function renderSuggestions() {
    suggestionsEl.innerHTML = '';
    SUGGESTIONS.forEach((s, index) => {
      const btn = document.createElement('button');
      btn.className = 'chip';
      btn.innerHTML = `<i class="fas fa-music"></i> ${s.title}`;
      btn.onclick = () => {
        loadSong(s.id, s.title, s.channel, true);
        currentSuggestionIndex = index;
      };
      suggestionsEl.appendChild(btn);
    });
  }
  
  // Recently Played Functions
  function loadRecentlyPlayed() {
    try {
      const stored = localStorage.getItem('recentlyPlayedSongs');
      if (stored) {
        recentlyPlayedSongs = JSON.parse(stored);
        renderRecentlyPlayed();
      }
    } catch (e) {
      console.log('Error loading recently played songs:', e);
      recentlyPlayedSongs = [];
    }
  }
  
  function addToRecentlyPlayed(videoId, title, channel) {
    const song = { id: videoId, title, channel, timestamp: Date.now() };
    
    // Remove if already exists
    recentlyPlayedSongs = recentlyPlayedSongs.filter(s => s.id !== videoId);
    
    // Add to beginning
    recentlyPlayedSongs.unshift(song);
    
    // Keep only MAX_RECENT_SONGS
    if (recentlyPlayedSongs.length > MAX_RECENT_SONGS) {
      recentlyPlayedSongs = recentlyPlayedSongs.slice(0, MAX_RECENT_SONGS);
    }
    
    // Save to localStorage
    try {
      localStorage.setItem('recentlyPlayedSongs', JSON.stringify(recentlyPlayedSongs));
    } catch (e) {
      console.log('Error saving recently played songs:', e);
    }
    
    renderRecentlyPlayed();
  }
  
  function renderRecentlyPlayed() {
    if (recentlyPlayedSongs.length === 0) {
      recentlyPlayedTitle.style.display = 'none';
      recentlyPlayedEl.innerHTML = '';
      return;
    }
    
    recentlyPlayedTitle.style.display = 'block';
    recentlyPlayedEl.innerHTML = '';
    
    recentlyPlayedSongs.forEach((song, index) => {
      const btn = document.createElement('button');
      btn.className = 'chip recent-chip';
      btn.innerHTML = `<i class="fas fa-history"></i> ${song.title}`;
      btn.onclick = () => {
        loadSong(song.id, song.title, song.channel, true);
      };
      recentlyPlayedEl.appendChild(btn);
    });
  }
  
  function clearRecentlyPlayed() {
    recentlyPlayedSongs = [];
    localStorage.removeItem('recentlyPlayedSongs');
    renderRecentlyPlayed();
    setStatus('Recently played history cleared', 'ready');
  }
  
  // Favorites Functions
  function loadFavorites() {
    try {
      const stored = localStorage.getItem('favoriteSongs');
      if (stored) {
        favoriteSongs = JSON.parse(stored);
        renderFavorites();
      }
    } catch (e) {
      console.log('Error loading favorites:', e);
      favoriteSongs = [];
    }
  }
  
  function addToFavorites(videoId, title, channel) {
    if (favoriteSongs.some(song => song.id === videoId)) {
      return false;
    }
    
    const song = { id: videoId, title, channel, timestamp: Date.now() };
    favoriteSongs.unshift(song);
    
    if (favoriteSongs.length > MAX_FAVORITES) {
      favoriteSongs = favoriteSongs.slice(0, MAX_FAVORITES);
    }
    
    try {
      localStorage.setItem('favoriteSongs', JSON.stringify(favoriteSongs));
    } catch (e) {
      console.log('Error saving favorites:', e);
    }
    
    renderFavorites();
    updateFavoriteButton();
    setStatus('Added to favorites! ❤️', 'ready');
    return true;
  }
  
  function removeFromFavorites(videoId) {
    favoriteSongs = favoriteSongs.filter(song => song.id !== videoId);
    
    try {
      localStorage.setItem('favoriteSongs', JSON.stringify(favoriteSongs));
    } catch (e) {
      console.log('Error saving favorites:', e);
    }
    
    renderFavorites();
    updateFavoriteButton();
    setStatus('Removed from favorites', 'ready');
  }
  
  function isFavorite(videoId) {
    return favoriteSongs.some(song => song.id === videoId);
  }
  
  function renderFavorites() {
    if (favoriteSongs.length === 0) {
      favoritesTitle.style.display = 'none';
      favoritesEl.innerHTML = '';
      return;
    }
    
    favoritesTitle.style.display = 'block';
    favoritesEl.innerHTML = '';
    
    favoriteSongs.forEach((song, index) => {
      const btn = document.createElement('button');
      btn.className = 'chip favorite-chip';
      btn.innerHTML = `<i class="fas fa-heart"></i> ${song.title}`;
      btn.onclick = () => {
        loadSong(song.id, song.title, song.channel, true);
      };
      
      btn.oncontextmenu = (e) => {
        e.preventDefault();
        if (confirm(`Remove "${song.title}" from favorites?`)) {
          removeFromFavorites(song.id);
        }
      };
      
      favoritesEl.appendChild(btn);
    });
  }
  
  function updateFavoriteButton() {
    if (!currentVideoId) return;
    
    if (isFavorite(currentVideoId)) {
      favoriteBtn.innerHTML = '<i class="fas fa-heart"></i>';
      favoriteBtn.style.color = '#e91e63';
      favoriteBtn.title = 'Remove from Favorites';
    } else {
      favoriteBtn.innerHTML = '<i class="far fa-heart"></i>';
      favoriteBtn.style.color = '';
      favoriteBtn.title = 'Add to Favorites';
    }
  }
  
  function toggleFavorite() {
    if (!currentVideoId) {
      setStatus('No song loaded', 'error');
      return;
    }
    
    if (isFavorite(currentVideoId)) {
      removeFromFavorites(currentVideoId);
    } else {
      addToFavorites(currentVideoId, currentVideoTitle, currentVideoChannel);
    }
  }
  
  // Repeat & Shuffle Functions
  function loadPlaybackSettings() {
    try {
      const savedRepeat = localStorage.getItem('repeatMode');
      const savedShuffle = localStorage.getItem('shuffleMode');
      const savedSpeed = localStorage.getItem('playbackSpeed');
      
      if (savedRepeat && ['none', 'one', 'all'].includes(savedRepeat)) {
        repeatMode = savedRepeat;
      }
      
      if (savedShuffle !== null) {
        shuffleMode = savedShuffle === 'true';
      }
      
      if (savedSpeed) {
        const speed = parseFloat(savedSpeed);
        if (availableSpeeds.includes(speed)) {
          playbackSpeed = speed;
        }
      }
      
      updateRepeatButton();
      updateShuffleButton();
      updateSpeedButton();
    } catch (e) {
      console.log('Error loading playback settings:', e);
    }
  }
  
  function savePlaybackSettings() {
    try {
      localStorage.setItem('repeatMode', repeatMode);
      localStorage.setItem('shuffleMode', shuffleMode.toString());
      localStorage.setItem('playbackSpeed', playbackSpeed.toString());
    } catch (e) {
      console.log('Error saving playback settings:', e);
    }
  }
  
  // Speed Control Functions
  function cyclePlaybackSpeed() {
    const currentIndex = availableSpeeds.indexOf(playbackSpeed);
    const nextIndex = (currentIndex + 1) % availableSpeeds.length;
    playbackSpeed = availableSpeeds[nextIndex];
    
    applyPlaybackSpeed();
    updateSpeedButton();
    savePlaybackSettings();
    
    setStatus(`Speed: ${playbackSpeed}x`, 'ready');
  }
  
  function applyPlaybackSpeed() {
    if (player && currentVideoId) {
      try {
        player.setPlaybackRate(playbackSpeed);
      } catch(e) {
        console.log('Error setting playback speed:', e);
      }
    }
  }
  
  function updateSpeedButton() {
    speedBtn.innerHTML = `<span class="speed-text">${playbackSpeed}x</span>`;
    speedBtn.title = `Playback Speed: ${playbackSpeed}x`;
    
    if (playbackSpeed < 1) {
      speedBtn.style.color = '#ff9800';
    } else if (playbackSpeed > 1) {
      speedBtn.style.color = '#4caf50';
    } else {
      speedBtn.style.color = '';
    }
  }
  
  // Song Queue Functions
  function addToQueue(videoId, title, channel) {
    if (songQueue.some(song => song.id === videoId)) {
      setStatus('Song already in queue', 'error');
      return false;
    }
    
    if (songQueue.length >= MAX_QUEUE_SIZE) {
      setStatus(`Queue full (max ${MAX_QUEUE_SIZE} songs)`, 'error');
      return false;
    }
    
    const song = { id: videoId, title, channel, timestamp: Date.now() };
    songQueue.push(song);
    
    try {
      localStorage.setItem('songQueue', JSON.stringify(songQueue));
    } catch (e) {
      console.log('Error saving queue:', e);
    }
    
    renderQueue();
    setStatus(`Added to queue: ${title}`, 'ready');
    return true;
  }
  
  function renderQueue() {
    if (songQueue.length === 0) {
      queueTitle.style.display = 'none';
      queueEl.innerHTML = '';
      return;
    }
    
    queueTitle.style.display = 'block';
    queueEl.innerHTML = '';
    
    songQueue.forEach((song, index) => {
      const btn = document.createElement('button');
      btn.className = 'chip queue-chip';
      btn.innerHTML = `🎵 ${song.title}`;
      btn.onclick = () => {
        loadSong(song.id, song.title, song.channel, true);
        songQueue.splice(index, 1);
        localStorage.setItem('songQueue', JSON.stringify(songQueue));
        renderQueue();
      };
      
      btn.oncontextmenu = (e) => {
        e.preventDefault();
        songQueue.splice(index, 1);
        localStorage.setItem('songQueue', JSON.stringify(songQueue));
        renderQueue();
        setStatus('Removed from queue', 'ready');
      };
      
      queueEl.appendChild(btn);
    });
  }
  
  function toggleRepeatMode() {
    const modes = ['none', 'one', 'all'];
    const currentIndex = modes.indexOf(repeatMode);
    repeatMode = modes[(currentIndex + 1) % modes.length];
    
    updateRepeatButton();
    savePlaybackSettings();
    
    const modeNames = { none: 'Off', one: 'One', all: 'All' };
    setStatus(`Repeat: ${modeNames[repeatMode]}`, 'ready');
  }
  
  function toggleShuffleMode() {
    shuffleMode = !shuffleMode;
    updateShuffleButton();
    savePlaybackSettings();
    
    if (shuffleMode) {
      setStatus('Shuffle: On 🔀', 'ready');
      createShuffledPlaylist();
    } else {
      setStatus('Shuffle: Off', 'ready');
      resetPlaylist();
    }
  }
  
  function updateRepeatButton() {
    const icons = {
      none: '<i class="fas fa-redo"></i>',
      one: '<i class="fas fa-redo"></i><span style="font-size: 8px;">1</span>',
      all: '<i class="fas fa-redo"></i>'
    };
    
    const colors = {
      none: '',
      one: '#ffc107',
      all: '#28a745'
    };
    
    const titles = {
      none: 'Repeat: Off',
      one: 'Repeat: One',
      all: 'Repeat: All'
    };
    
    repeatBtn.innerHTML = icons[repeatMode];
    repeatBtn.style.color = colors[repeatMode];
    repeatBtn.title = titles[repeatMode];
  }
  
  function updateShuffleButton() {
    if (shuffleMode) {
      shuffleBtn.style.color = '#17a2b8';
      shuffleBtn.title = 'Shuffle: On';
    } else {
      shuffleBtn.style.color = '';
      shuffleBtn.title = 'Shuffle: Off';
    }
  }
  
  function createPlaylist() {
    // Create playlist from all available songs
    currentPlaylist = [...SUGGESTIONS, ...favoriteSongs, ...recentlyPlayedSongs];
    
    // Remove duplicates
    const seen = new Set();
    currentPlaylist = currentPlaylist.filter(song => {
      if (seen.has(song.id)) {
        return false;
      }
      seen.add(song.id);
      return true;
    });
    
    // Find current song index
    currentPlaylistIndex = currentPlaylist.findIndex(song => song.id === currentVideoId);
    if (currentPlaylistIndex === -1) currentPlaylistIndex = 0;
  }
  
  function createShuffledPlaylist() {
    createPlaylist();
    
    // Shuffle the playlist but keep current song at the beginning
    const currentSong = currentPlaylist[currentPlaylistIndex];
    const otherSongs = currentPlaylist.filter((_, index) => index !== currentPlaylistIndex);
    
    // Fisher-Yates shuffle
    for (let i = otherSongs.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [otherSongs[i], otherSongs[j]] = [otherSongs[j], otherSongs[i]];
    }
    
    currentPlaylist = [currentSong, ...otherSongs];
    currentPlaylistIndex = 0;
  }
  
  function resetPlaylist() {
    createPlaylist();
  }
  
  function playNext() {
    if (currentPlaylist.length === 0) {
      createPlaylist();
    }
    
    if (currentPlaylist.length === 0) return;
    
    if (repeatMode === 'one') {
      // Replay current song
      if (player && currentVideoId) {
        try {
          player.seekTo(0, true);
          player.playVideo();
        } catch(e) {
          console.log('Error replaying song:', e);
        }
      }
      return;
    }
    
    // Move to next song
    currentPlaylistIndex++;
    
    if (currentPlaylistIndex >= currentPlaylist.length) {
      if (repeatMode === 'all') {
        currentPlaylistIndex = 0;
        if (shuffleMode) {
          createShuffledPlaylist();
        }
      } else {
        setStatus('Playlist ended', 'ready');
        return;
      }
    }
    
    const nextSong = currentPlaylist[currentPlaylistIndex];
    if (nextSong) {
      loadSong(nextSong.id, nextSong.title, nextSong.channel, true);
    }
  }
  
  function playPrevious() {
    if (currentPlaylist.length === 0) {
      createPlaylist();
    }
    
    if (currentPlaylist.length === 0) return;
    
    currentPlaylistIndex--;
    
    if (currentPlaylistIndex < 0) {
      if (repeatMode === 'all') {
        currentPlaylistIndex = currentPlaylist.length - 1;
      } else {
        currentPlaylistIndex = 0;
        return;
      }
    }
    
    const prevSong = currentPlaylist[currentPlaylistIndex];
    if (prevSong) {
      loadSong(prevSong.id, prevSong.title, prevSong.channel, true);
    }
  }
  
  // Keyboard Shortcuts
  function handleKeyboardShortcuts(e) {
    if (!keyboardShortcutsEnabled) return;
    
    // Don't trigger shortcuts if user is typing in an input field
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
    
    switch(e.code) {
      case 'Space':
        e.preventDefault();
        togglePlayPause();
        break;
        
      case 'ArrowLeft':
        e.preventDefault();
        seekBackward();
        break;
        
      case 'ArrowRight':
        e.preventDefault();
        seekForward();
        break;
        
      case 'ArrowUp':
        e.preventDefault();
        adjustVolume(10);
        break;
        
      case 'ArrowDown':
        e.preventDefault();
        adjustVolume(-10);
        break;
        
      case 'KeyM':
        e.preventDefault();
        toggleMute();
        break;
        
      case 'KeyF':
        e.preventDefault();
        toggleFullscreen();
        break;
        
      case 'Comma':
        if (e.shiftKey) {
          e.preventDefault();
          changePlaybackSpeed(-0.25);
        }
        break;
        
      case 'Period':
        if (e.shiftKey) {
          e.preventDefault();
          changePlaybackSpeed(0.25);
        }
        break;
        
      case 'Digit0':
      case 'Digit1':
      case 'Digit2':
      case 'Digit3':
      case 'Digit4':
      case 'Digit5':
      case 'Digit6':
      case 'Digit7':
      case 'Digit8':
      case 'Digit9':
        e.preventDefault();
        const percentage = parseInt(e.code.slice(-1)) * 10;
        seekToPercentage(percentage);
        break;
        
      case 'Home':
        e.preventDefault();
        seekToPercentage(0);
        break;
        
      case 'End':
        e.preventDefault();
        seekToPercentage(100);
        break;
    }
  }
  
  function togglePlayPause() {
    if (player && currentVideoId) {
      try {
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      } catch(e) {
        console.log('Error with play/pause:', e);
      }
    }
  }
  
  function seekBackward() {
    if (player && currentVideoId) {
      try {
        const currentTime = player.getCurrentTime();
        player.seekTo(Math.max(0, currentTime - 10), true);
        setStatus('Seeked backward 10s', 'ready');
      } catch(e) {
        console.log('Error seeking backward:', e);
      }
    }
  }
  
  function seekForward() {
    if (player && currentVideoId) {
      try {
        const currentTime = player.getCurrentTime();
        const duration = player.getDuration();
        player.seekTo(Math.min(duration, currentTime + 10), true);
        setStatus('Seeked forward 10s', 'ready');
      } catch(e) {
        console.log('Error seeking forward:', e);
      }
    }
  }
  
  function adjustVolume(change) {
    if (player && currentVideoId) {
      try {
        const currentVolume = player.getVolume();
        const newVolume = Math.max(0, Math.min(100, currentVolume + change));
        player.setVolume(newVolume);
        volumeEl.value = newVolume;
        setStatus(`Volume: ${newVolume}%`, 'ready');
      } catch(e) {
        console.log('Error adjusting volume:', e);
      }
    }
  }
  
  function toggleMute() {
    if (player && currentVideoId) {
      try {
        if (player.isMuted()) {
          player.unMute();
          setStatus('Unmuted', 'ready');
        } else {
          player.mute();
          setStatus('Muted', 'ready');
        }
      } catch(e) {
        console.log('Error toggling mute:', e);
      }
    }
  }
  
  function toggleFullscreen() {
    if (document.fullscreenElement) {
      document.exitFullscreen();
      setStatus('Exited fullscreen', 'ready');
    } else {
      document.documentElement.requestFullscreen();
      setStatus('Entered fullscreen', 'ready');
    }
  }
  
  function changePlaybackSpeed(change) {
    if (player && currentVideoId) {
      try {
        const currentRate = player.getPlaybackRate();
        const newRate = Math.max(0.25, Math.min(2, currentRate + change));
        player.setPlaybackRate(newRate);
        setStatus(`Speed: ${newRate}x`, 'ready');
      } catch(e) {
        console.log('Error changing playback speed:', e);
      }
    }
  }
  
  function seekToPercentage(percentage) {
    if (player && currentVideoId) {
      try {
        const duration = player.getDuration();
        const targetTime = (percentage / 100) * duration;
        player.seekTo(targetTime, true);
        setStatus(`Seeked to ${percentage}%`, 'ready');
      } catch(e) {
        console.log('Error seeking to percentage:', e);
      }
    }
  }
  
  // Theme Functions
  function loadTheme() {
    try {
      const saved = localStorage.getItem('selectedTheme');
      if (saved && themes[saved]) {
        currentTheme = saved;
        applyTheme(currentTheme);
      }
    } catch (e) {
      console.log('Error loading theme:', e);
    }
  }
  
  function applyTheme(themeKey) {
    // Remove all theme classes
    Object.values(themes).forEach(theme => {
      if (theme.class) {
        document.body.classList.remove(theme.class);
      }
    });
    
    // Apply new theme
    if (themes[themeKey] && themes[themeKey].class) {
      document.body.classList.add(themes[themeKey].class);
    }
    
    currentTheme = themeKey;
    
    // Save to localStorage
    try {
      localStorage.setItem('selectedTheme', themeKey);
    } catch (e) {
      console.log('Error saving theme:', e);
    }
    
    setStatus(`Theme changed to ${themes[themeKey].name}`, 'ready');
  }
  
  function showThemeSelector() {
    const themeOptions = Object.entries(themes)
      .map(([key, theme]) => `${key === currentTheme ? '✓' : ' '} ${theme.name}`)
      .join('\n');
    
    const selection = prompt(`Choose a theme:\n\n${themeOptions}\n\nEnter: default, light, ocean, forest, sunset, neon, or rose`);
    
    if (selection && themes[selection.toLowerCase()]) {
      applyTheme(selection.toLowerCase());
    }
  }
  
  // Add keyboard shortcut help
  function showKeyboardHelp() {
    const helpText = `
Keyboard Shortcuts:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SPACE          Play/Pause
← →            Seek backward/forward (10s)
↑ ↓            Volume up/down
M              Mute/Unmute
F              Toggle fullscreen
0-9            Seek to percentage (0% to 90%)
HOME           Seek to beginning
END            Seek to end
SHIFT + <      Decrease speed
SHIFT + >      Increase speed
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━`;
    
    alert(helpText);
  }
  
  // Event listeners for keyboard shortcuts
  document.addEventListener('keydown', handleKeyboardShortcuts);
  
  // Event listeners for recently played
  clearHistoryBtn.addEventListener('click', () => {
    if (confirm('Clear your recently played history?')) {
      clearRecentlyPlayed();
    }
  });
  
  // Initial renders
  loadTheme();
  loadPlaybackSettings();
  loadFavorites();
  loadRecentlyPlayed();
  // Load queue
  try {
    const stored = localStorage.getItem('songQueue');
    if (stored) {
      songQueue = JSON.parse(stored);
      renderQueue();
    }
  } catch (e) {
    console.log('Error loading queue:', e);
    songQueue = [];
  }
  renderSuggestions();
  
  // Event listeners for favorites
  favoriteBtn.addEventListener('click', toggleFavorite);
  
  clearFavoritesBtn.addEventListener('click', () => {
    if (confirm('Clear all your favorite songs?')) {
      favoriteSongs = [];
      localStorage.removeItem('favoriteSongs');
      renderFavorites();
      updateFavoriteButton();
      setStatus('All favorites cleared', 'ready');
    }
  });
  
  // Event listeners for repeat & shuffle
  repeatBtn.addEventListener('click', toggleRepeatMode);
  shuffleBtn.addEventListener('click', toggleShuffleMode);
  
  // Event listener for speed control
  speedBtn.addEventListener('click', cyclePlaybackSpeed);
  
  // Event listeners for queue
  clearQueueBtn.addEventListener('click', () => {
    if (confirm('Clear all songs from queue?')) {
      songQueue = [];
      localStorage.removeItem('songQueue');
      renderQueue();
      setStatus('Queue cleared', 'ready');
    }
  });
  
  // Update prev/next button functionality
  prevBtn.addEventListener('click', playPrevious);
  nextBtn.addEventListener('click', playNext);
  
  // Event listeners for search
  searchTab.addEventListener('click', switchToSearchTab);
  urlTab.addEventListener('click', switchToUrlTab);
  
  searchBtn.addEventListener('click', () => {
    performSearch(searchInput.value);
  });
  
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      performSearch(searchInput.value);
    }
  });
  
  // Real-time search with debouncing
  searchInput.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (e.target.value.trim().length > 2) {
        performSearch(e.target.value);
      }
    }, 500);
  });

  // YouTube API ready
  function onYouTubeIframeAPIReady() {
    ytReady = true;
    setStatus('YouTube API ready', 'ready');
  }
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

  // Create YT player - FIXED VERSION
  function createYTPlayer(videoId, autoplay = true, startSeconds = 0) {
    console.log('createYTPlayer called with videoId:', videoId);
    
    // Clear any existing content
    if (fallbackIframe) {
      try { fallbackIframe.remove(); } catch(e) {}
      fallbackIframe = null;
    }
    
    // Use the correct container reference
    playerContainer.innerHTML = `
      <img class="thumbnail" id="thumbnailImg" src="https://i.ytimg.com/vi/${videoId}/hqdefault.jpg" alt="${currentVideoTitle}">
      <div class="thumbnail-overlay">
        <button class="play-thumb-button" id="thumbPlay">
          <i class="fas fa-pause"></i>
        </button>
      </div>
      <div id="ytplayer_inner"></div>
    `;
    
    // Create the YouTube player
    try {
      player = new YT.Player('ytplayer_inner', {
        width: '100%', 
        height: '100%', 
        videoId: videoId,
        playerVars: {
          autoplay: autoplay ? 1 : 0,
          playsinline: 1,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          enablejsapi: 1,
          origin: location.origin || 'null'
        },
        events: {
          onReady: function(e) {
            console.log('YouTube player ready');
            try { 
              player.setVolume(parseInt(volumeEl.value,10));
              // Apply saved speed
              setTimeout(() => applyPlaybackSpeed(), 100); 
            } catch(e){ console.log('Volume set error:', e); }
            
            if (startSeconds > 0) {
              try { 
                player.seekTo(startSeconds, true); 
              } catch(e){ console.log('Seek error:', e); }
            }
            
            if (autoplay) {
              try { 
                player.playVideo(); 
                isPlaying = true;
                updatePlayButton();
                setStatus('Playing', 'playing');
                startProgress();
              } catch(e){ console.log('Play error:', e); }
            }
          },
          onStateChange: onPlayerStateChange,
          onError: function(e) {
            setStatus('Error playing video', 'error');
            console.error('YouTube player error:', e);
          }
        }
      });
    } catch(e) {
      console.error('Error creating YouTube player:', e);
      createFallbackIframe(videoId);
    }
  }

  function onPlayerStateChange(ev) {
    const s = ev.data;
    if (s === YT.PlayerState.PLAYING) { 
      isPlaying = true;
      updatePlayButton();
      setStatus('Playing', 'playing'); 
      startProgress(); 
    }
    else if (s === YT.PlayerState.PAUSED) { 
      isPlaying = false;
      updatePlayButton();
      setStatus('Paused', 'paused'); 
      stopProgress(); 
    }
    else if (s === YT.PlayerState.ENDED) { 
      isPlaying = false;
      updatePlayButton();
      setStatus('Song ended - playing next...', 'ready'); 
      stopProgress(); 
      progressFill.style.width = '100%';
      // Autoplay next song based on repeat mode
      setTimeout(() => {
        playNext();
      }, 1000);
    }
    else if (s === YT.PlayerState.BUFFERING) { 
      setStatus('Buffering...', 'paused'); 
    }
    else if (s === YT.PlayerState.CUED) { 
      setStatus('Cued', 'ready'); 
    }
  }

  function updatePlayButton() {
    if (isPlaying) {
      playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
      const thumbBtn = document.getElementById('thumbPlay');
      if (thumbBtn) thumbBtn.innerHTML = '<i class="fas fa-pause"></i>';
    } else {
      playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
      const thumbBtn = document.getElementById('thumbPlay');
      if (thumbBtn) thumbBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
  }

  // Fallback iframe
  function createFallbackIframe(videoId) {
    console.log('Creating fallback iframe for:', videoId);
    if (fallbackIframe) try { fallbackIframe.remove(); } catch(e){}
    if (player) {
      try { player.destroy(); } catch(e){}
      player = null;
    }
    
    playerContainer.innerHTML = '';
    const ifr = document.createElement('iframe');
    ifr.className = 'yt';
    ifr.style.width = '100%';
    ifr.style.height = '100%';
    ifr.src = 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&playsinline=1&controls=0&rel=0&modestbranding=1&enablejsapi=1';
    ifr.allow = 'autoplay; encrypted-media; fullscreen';
    ifr.setAttribute('frameborder','0');
    playerContainer.appendChild(ifr);
    fallbackIframe = ifr;
    
    isPlaying = true;
    updatePlayButton();
    setStatus('Playing (fallback mode)', 'playing');
    updateThumbnail(videoId);
    
    stopProgress();
    timeCurEl.textContent = '0:00';
    timeDurEl.textContent = '—';
  }

  // UI: Load, Play, Stop
  function onLoadClicked(userGesture = false) {
    const id = extractVideoID(urlInput.value);
    if (!id) { 
      setStatus('Invalid YouTube link or ID', 'error'); 
      return; 
    }
    
    currentVideoId = id;
    
    // Try to get video title from suggestions
    const suggestion = SUGGESTIONS.find(s => s.id === id);
    if (suggestion) {
      currentVideoTitle = suggestion.title;
      currentVideoChannel = suggestion.channel;
    } else {
      currentVideoTitle = "Loaded Video";
      currentVideoChannel = "YouTube";
    }
    
    songTitleEl.textContent = currentVideoTitle;
    songChannelEl.textContent = currentVideoChannel;
    updateThumbnail(id);
    
    loadBtn.innerHTML = '<div class="loader"></div> Loading';
    loadBtn.disabled = true;
    
    setTimeout(() => {
      if (ytReady) {
        createYTPlayer(id, true, 0);
      } else {
        createFallbackIframe(id);
      }
      loadBtn.innerHTML = '<i class="fas fa-download"></i> Load';
      loadBtn.disabled = false;
    }, 500);
  }

  // Progress tracking functions
  function startProgress() {
    stopProgress();
    progressTimer = setInterval(updateProgress, 1000);
  }

  function stopProgress() {
    if (progressTimer) {
      clearInterval(progressTimer);
      progressTimer = null;
    }
  }

  function updateProgress() {
    if (!player || !player.getCurrentTime) return;
    
    try {
      const current = player.getCurrentTime();
      const duration = player.getDuration();
      
      if (current && duration) {
        const percent = (current / duration) * 100;
        progressFill.style.width = percent + '%';
        timeCurEl.textContent = formatTime(current);
        timeDurEl.textContent = formatTime(duration);
      }
    } catch(e) {
      console.log('Progress update error:', e);
    }
  }

  // Event listeners
  loadBtn.onclick = () => onLoadClicked(true);

  playPauseBtn.onclick = () => {
    if (!player && !fallbackIframe) {
      if (currentVideoId) {
        if (ytReady) {
          createYTPlayer(currentVideoId, true);
        } else {
          createFallbackIframe(currentVideoId);
        }
      }
      return;
    }

    if (player && player.getPlayerState) {
      try {
        const state = player.getPlayerState();
        if (state === YT.PlayerState.PLAYING) {
          player.pauseVideo();
        } else {
          player.playVideo();
        }
      } catch(e) {
        console.log('Play/pause error:', e);
      }
    }
  };

  // Thumbnail play button
  document.addEventListener('click', (e) => {
    if (e.target.id === 'thumbPlay' || e.target.parentElement?.id === 'thumbPlay') {
      playPauseBtn.click();
    }
  });

  volumeEl.oninput = () => {
    if (player && player.setVolume) {
      try {
        player.setVolume(parseInt(volumeEl.value, 10));
      } catch(e) {
        console.log('Volume change error:', e);
      }
    }
  };

  // Navigation and autoplay functions
  function playNextSong() {
    if (currentSuggestionIndex < SUGGESTIONS.length - 1) {
      currentSuggestionIndex++;
    } else {
      // Loop back to first song
      currentSuggestionIndex = 0;
    }
    const next = SUGGESTIONS[currentSuggestionIndex];
    urlInput.value = next.url;
    onLoadClicked(true);
  }

  function playPrevSong() {
    if (currentSuggestionIndex > 0) {
      currentSuggestionIndex--;
    } else {
      // Loop to last song
      currentSuggestionIndex = SUGGESTIONS.length - 1;
    }
    const prev = SUGGESTIONS[currentSuggestionIndex];
    urlInput.value = prev.url;
    onLoadClicked(true);
  }

  // Navigation buttons
  prevBtn.onclick = () => {
    playPrevSong();
  };

  nextBtn.onclick = () => {
    playNextSong();
  };

  progressBar.onclick = (e) => {
    if (!player || !player.getDuration) return;
    
    try {
      const duration = player.getDuration();
      const rect = progressBar.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      const seekTo = duration * percent;
      player.seekTo(seekTo, true);
    } catch(e) {
      console.log('Seek error:', e);
    }
  };

  // Refresh suggestions functionality
  function refreshSuggestions() {
    // Randomly select 4 songs from trending suggestions
    const shuffled = [...TRENDING_SUGGESTIONS].sort(() => 0.5 - Math.random());
    SUGGESTIONS = shuffled.slice(0, 4);
    renderSuggestions();
    setStatus('Suggestions refreshed!', 'ready');
  }

  // Download functionality
  function downloadAudio() {
    const id = extractVideoID(urlInput.value);
    if (!id) {
      setStatus('Please enter a valid YouTube URL first', 'error');
      return;
    }
    
    // Create download link using yt-dlp compatible service
    const downloadUrl = `https://loader.to/api/button/?f=mp3&color=ff0000&url=https://www.youtube.com/watch?v=${id}`;
    
    // Open download page in new tab
    const downloadWindow = window.open(downloadUrl, '_blank');
    if (downloadWindow) {
      setStatus('Opening download page...', 'ready');
    } else {
      // Fallback - create a temporary link
      const link = document.createElement('a');
      link.href = downloadUrl;
      link.target = '_blank';
      link.click();
      setStatus('Download initiated', 'ready');
    }
  }

  // Event listeners for new buttons
  refreshBtn.onclick = refreshSuggestions;
  downloadBtn.onclick = downloadAudio;

  console.log('YouTube Audio Player fully initialized with autoplay, dynamic suggestions, and download support');
  </script>
</body>
</html>
